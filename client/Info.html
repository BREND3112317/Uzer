<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Info</title>
    <style>
        .app {

        }

        .container {

        }
    </style>

</head>
<body>
    <div id="app">
        <div class="container">
            <div class="info">
                <div id="info-account">
                </div>
                <div id="info-username">
                </div>
                <div class="auth">
                    <button id="logout-submit">登出</button>
                </div>

            </div>
        </div>
    </div>
    <!-- <script type="text/javascript" src="/static/AJAX.js"></script> -->
    <script type="application/javascript">
        cSystemCall = {
            notify: function (content, title) {
                console.log("[cSystemCall - notify]", title + ": ", content);
            }
        }
        
        AJAX = {
            get: function (url, callback) {
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.open("GET", url);
                xmlhttp.onreadystatechange = function () {
                    if(xmlhttp.readyState != 4) return;
                                
                    var data = {};
                    try {
                        data = JSON.parse(xmlhttp.responseText);
                        if(xmlhttp.status >= 200 && xmlhttp.status < 300) {
                            if(typeof callback.success !== 'undefined') {
                                callback.success(data);
                            }else {
                                if(typeof callback.failed !== 'undefined') {
                                    callback.failed(data);
                                } else {
                                    cSystemCall.notify(data, "callback.failed is undefined");
                                }
                            }
                        }else{
                            cSystemCall.notify(`ajax GET error status: ${xmlhttp.status}`, data);
                            callback.failed(data);
                        }
                    } catch (e) {
                        console.log("xmlhttp error:", e);
                        console.log("xmlhttp error response:", xmlhttp.responseText);
                    }
                }
                xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                xmlhttp.send();
                return xmlhttp;
            },
            post: function (url, datajson, callback) {
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.open("POST", url);
                xmlhttp.onreadystatechange = function () {
                    if(xmlhttp.readyState != 4) return;
                                
                    var data = {};
                    try {
                        data = JSON.parse(xmlhttp.responseText);
                        if(xmlhttp.status >= 200 && xmlhttp.status < 300) {
                            if(typeof callback.success !== 'undefined') {
                                callback.success(data);
                            }else {
                                if(typeof callback.failed !== 'undefined') {
                                    callback.failed(data);
                                } else {
                                    cSystemCall.notify(data, "callback.failed is undefined");
                                }
                            }
                        }else{
                            cSystemCall.notify(`ajax POST error status: ${xmlhttp.status}`, data);
                            callback.failed(data);
                            // cSystemCall.notify(data, `status is outside: ${xmlhttp.status}`);
                        }
                    } catch (e) {
                        console.log("[xmlhttp error message]", e);
                        console.log("xmlhttp error response:", xmlhttp.responseText);
                    }
                }
                xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                console.log(JSON.stringify(datajson));
                xmlhttp.send(JSON.stringify(datajson));
                return xmlhttp;
            },
            put: (url, datajson, callback) => {
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.open("PUT", url);
                xmlhttp.onreadystatechange = function () {
                    if(xmlhttp.readyState != 4) return;
                                
                    var data = {};
                    try {
                        data = JSON.parse(xmlhttp.responseText);
                        if(xmlhttp.status >= 200 && xmlhttp.status < 300) {
                            if(typeof callback.success !== 'undefined') {
                                callback.success(data);
                            }else {
                                if(typeof callback.failed !== 'undefined') {
                                    callback.failed(data);
                                } else {
                                    cSystemCall.notify(data, "callback.failed is undefined");
                                }
                            }
                        }else{
                            cSystemCall.notify(`ajax POST error status: ${xmlhttp.status}`, data);
                            callback.failed(data);
                            // cSystemCall.notify(data, `status is outside: ${xmlhttp.status}`);
                        }
                    } catch (e) {
                        console.log("[xmlhttp error message]", e);
                        console.log("xmlhttp error response:", xmlhttp.responseText);
                    }
                }
                xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                console.log(JSON.stringify(datajson));
                xmlhttp.send(JSON.stringify(datajson));
                return xmlhttp;
            }
        }

        pre_updateUser = () => {
            
        }

        pre_checkAuth = (callback) => {
            AJAX.get(
                "https://codebackend.brlin.org/auth/local/session",
                {
                    success: (data) => {
                        // window.location = "/info";
                        if(callback.success !== undefined)callback.success(data);
                    },
                    failed: (err) => {
                        console.log("err", err);
                        if(callback.failed !== undefined)callback.failed(err);
                        //
                    }
                }
            )
        }

        checkAuth = (callback) => {
            AJAX.get(
                "https://codebackend.brlin.org/auth/local/session",
                {
                    success: (data) => {
                        // window.location = "/info";
                        if(callback.success !== undefined)callback.success(data);
                    },
                    failed: (err) => {
                        console.log("err", err);
                        if(callback.failed !== undefined)callback.failed(err);
                        //
                    }
                }
            )
        }

        pre_logout = () => {
            logout();
        }

        logout = () => {
            AJAX.get(
                "https://codebackend.brlin.org/auth/local/logout",
                {
                    success: (data) => {
                        console.log("success", data);
                        window.location = "/signin";
                    },
                    failed: (err) => {
                        console.log("err", err);
                    }
                }
            )
        }

        LoadInfo = (account, password) => {
            console.log(account, password);
            AJAX.get(
                "https://codebackend.brlin.org/api/user",
                {
                    success: (data) => {
                        console.log("success", data.data);
                        document.getElementById("info-account").innerText = data.data.account;
                        document.getElementById("info-username").innerText = data.data.username;
                    },
                    failed: (err) => {
                        console.log("err", err);
                        window.location = "/signin";
                        pre_checkAuth();
                    }
                }
            )
            // alert(`account: ${account}, password: ${password}`);
        }

        window.onload=function(){
            LoadInfo();
            document.getElementById("logout-submit").onclick = () => {
                pre_logout();
            };
        }
    </script>
</body>
</html>